<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FixCourseList</title>
</head>

<style>
  div {
    margin: 30px 0;
  }

  form * {
    display: block;
    margin: 10px;
  }
</style>

<script>
  // Course List
  var name = "", toDownload;
</script>

<script>
  async function loadFile(file) {
    if (file === undefined) return;

    let status = document.getElementById("status");
    status.innerHTML = "Ready for loading file"
    status.style = "color: black;"
    let t = await file.text();
    return { name: file.name, text: t };
  }

  // https://stackoverflow.com/a/18197341/13053641
  function download(filename, text) {
    var element = document.createElement('a');
    element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
    element.setAttribute('download', filename);

    element.style.display = 'none';
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
  }

  function checkFileNameValidity(fileName) {
    let lastPointIndex = fileName.lastIndexOf('.');
    return lastPointIndex == -1 || fileName.substr(lastPointIndex + 1).toLowerCase() == "csv" || fileName.substr(lastPointIndex + 1).toLowerCase() == "txt";
  }

  function manageDownloadable(val) {
    let bt = document.getElementById('dl');
    bt.disabled = !val;
  }

  function processFile(ps) {
    // For Documentation/Annotation, see fixCourseList.py
    // The logic is totally same
    ps.then(function (res) {
      let status = document.getElementById("status");
      if (!checkFileNameValidity(res.name)) {
        status.innerHTML = "Error: The file name does not match the expected type: *file, *.csv, *.txt; Actual: " + res.name;
        status.style = "color: red;"
        manageDownloadable(false);
        throw new Error("The file name does not match the expected type: *file, *.csv, *.txt; Actual: " + res.name);
      }
      name = res.name;
      let text = res.text;
      let lines = text.split('\n');
      let toDelete = [];

      let classes = ["A", "B", "C", "D", "E", "F"];
      for (let i = 0, currentClass = "", currentInfo = "", processed = false; i < lines.length; i++, processed = false) {
        if (lines[i].indexOf("Q1") == -1 && lines[i].indexOf("Q2") == -1) {
          if (lines[i].indexOf("EF") != -1) {
            for (let cls of classes) {
              if (lines[i].indexOf(("\"d" + cls)) != -1 ||
                lines[i].indexOf(("\"e" + cls)) != -1 ||
                lines[i].indexOf(("\"m" + cls)) != -1) {
                if (lines[i].indexOf("EF" + cls.toLowerCase()) == -1) {
                  toDelete.push(lines[i]);
                  processed = true;
                }
                break;
              }
            }
          }

          if (!processed) {
            if (currentInfo != lines[i].substr(lines[i].indexOf(";")+7, 10)) {
              currentClass = lines[i].substr(lines[i].indexOf(";")+2, 3);
              currentInfo = lines[i].substr(lines[i].indexOf(";")+7, 10);
            }
            else if (currentInfo == lines[i].substr(lines[i].indexOf(";")+7, 10) && currentClass != lines[i].substr(lines[i].indexOf(";")+2, 3)) {
              toDelete.push(lines[i]);
            }
          }
        }
      }

      let processedLines = lines.filter(function (e) { return toDelete.indexOf(e) == -1 });
      toDownload = processedLines.join("\n");

      status.innerHTML = "Success. Ready for download.";
      status.style = "color: green;"
      manageDownloadable(true);
    })
  }

  function getDownloadName() {
    return Date.now().toString().substr(Date.now().toString().length - 4, 4) + 'FIXED-' + name;
  }

  function getDownloadContent() {
    return toDownload;
  }
</script>

<body>
  <h1>Fix Course List</h1>
  <p>Using the button below to choose a text file to fix. Use the second button to download the processed list.</p>

  <div>
    <p><b>Choose a text file to fix:</b></p>
    <form>
      <input type="file" onchange="processFile(loadFile(this.files[0]));">
    </form>
    <p>Status: </p>
    <p id="status">Ready for loading file</p>
  </div>

  <div>
    <p><b>Click the following button to download the processed file:</b></p>
    <button id="dl" onclick="download(getDownloadName(), getDownloadContent())" disabled>Download</button>
  </div>

</body>

</html>